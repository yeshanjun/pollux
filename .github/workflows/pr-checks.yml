name: PR Checks

on:
  pull_request:
    branches: ["main"]
    paths-ignore:
      - "**/*.md"
      - "LICENSE"
      - "**/*.png"
      - "**/*.jpg"
      - "**/*.example"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/PULL_REQUEST_TEMPLATE.md"

  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref_name }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  SQLX_OFFLINE: true
  CLAUDE_SYSTEM_PREAMBLE: ${{ vars.CLAUDE_SYSTEM_PREAMBLE }}

permissions:
  contents: read

jobs:
  quality:
    name: Cargo fmt && clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: Swatinem/rust-cache@v2
      - name: Check Formatting
        run: cargo fmt --all -- --check
      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  test:
    name: Cargo test
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - uses: actions/checkout@v4
      - uses: Swatinem/rust-cache@v2
      - name: Run Tests
        run: cargo test --locked

  check-linux:
    name: Cargo check Linux (${{ matrix.target_triple }})
    runs-on: ${{ matrix.runner }}
    needs: test
    strategy:
      fail-fast: false
      matrix:
        include:
          - target_triple: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
          - target_triple: x86_64-unknown-linux-musl
            runner: ubuntu-latest
            install_musl: true
          - target_triple: aarch64-unknown-linux-gnu
            runner: ubuntu-24.04-arm
          - target_triple: aarch64-unknown-linux-musl
            runner: ubuntu-24.04-arm
            install_musl: true
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        if: matrix.install_musl
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Add Rust Target
        run: rustup target add ${{ matrix.target_triple }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target_triple }}

      - name: Check
        run: cargo check --locked --target ${{ matrix.target_triple }}

  check-windows:
    name: Cargo check Windows
    runs-on: windows-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Add Rust Target
        run: rustup target add x86_64-pc-windows-msvc
      - uses: Swatinem/rust-cache@v2
      - name: Check
        run: cargo check --locked --target x86_64-pc-windows-msvc

  check-macos:
    name: Cargo check macOS (${{ matrix.target_triple }})
    runs-on: macos-latest
    needs: test
    strategy:
      fail-fast: false
      matrix:
        include:
          - target_triple: x86_64-apple-darwin
          - target_triple: aarch64-apple-darwin

    steps:
      - uses: actions/checkout@v4
      - name: Add Rust Target
        run: rustup target add ${{ matrix.target_triple }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target_triple }}
      - name: Check
        run: cargo check --locked --target ${{ matrix.target_triple }}
